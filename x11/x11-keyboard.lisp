(in-package :clui)

(defparameter *x11-querty-keymap*
  `((,+key-grave-accent+ "TLDE")
    (,+key-1+ "AE01")
    (,+key-2+ "AE02")
    (,+key-3+ "AE03")
    (,+key-4+ "AE04")
    (,+key-5+ "AE05")
    (,+key-6+ "AE06")
    (,+key-7+ "AE07")
    (,+key-8+ "AE08")
    (,+key-9+ "AE09")
    (,+key-0+ "AE10")
    (,+key-minus+ "AE11")
    (,+key-equals+ "AE12")
    
    (,+key-Q+ "AD01")
    (,+key-W+ "AD02")
    (,+key-E+ "AD03")
    (,+key-R+ "AD04")
    (,+key-T+ "AD05")
    (,+key-Y+ "AD06")
    (,+key-U+ "AD07")
    (,+key-I+ "AD08")
    (,+key-O+ "AD09")
    (,+key-P+ "AD10")
    (,+key-left-bracket+ "AD11")
    (,+key-right-bracket+ "AD12")

    (,+key-A+ "AC01")
    (,+key-S+ "AC02")
    (,+key-D+ "AC03")
    (,+key-F+ "AC04")
    (,+key-G+ "AC05")
    (,+key-H+ "AC06")
    (,+key-J+ "AC07")
    (,+key-K+ "AC08")
    (,+key-L+ "AC09")
    (,+key-semicolon+ "AC10")
    (,+key-apostrophe+ "AC11")
    
    (,+key-Z+ "AB01")
    (,+key-X+ "AB02")
    (,+key-C+ "AB03")
    (,+key-V+ "AB04")
    (,+key-B+ "AB05")
    (,+key-N+ "AB06")
    (,+key-M+ "AB07")
    (,+key-comma+ "AB08")
    (,+key-period+ "AB09")
    (,+key-slash+ "AB10")
    
    (,+key-backslash+ "BKSL")
    (,+key-international-1+ "LSGT")
    (,+key-spacebar+ "SPCE")
    (,+key-escape+ "ESC")
    (,+key-enter+ "RTRN")
    (,+key-tab+ "TAB")
    (,+key-backspace+ "BKSP")
    (,+key-insert+ "INS")
    (,+key-delete+ "DELE")
    (,+key-right-arrow+ "RGHT")
    (,+key-left-arrow+ "LEFT")
    (,+key-down-arrow+ "DOWN")
    (,+key-up-arrow+ "UP")
    (,+key-page-up+ "PGUP")
    (,+key-page-down+ "PGDN")
    (,+key-home+ "HOME")
    (,+key-end+ "END")
    (,+key-caps-lock+ "CAPS")
    (,+key-scroll-lock+ "SCLK")
    (,+key-num-lock+ "NMLK")
    (,+key-print-screen+ "PRSC")

    (,+key-F1+ "FK01")
    (,+key-F2+ "FK02")
    (,+key-F3+ "FK03")
    (,+key-F4+ "FK04")
    (,+key-F5+ "FK05")
    (,+key-F6+ "FK06")
    (,+key-F7+ "FK07")
    (,+key-F8+ "FK08")
    (,+key-F9+ "FK09")
    (,+key-F10+ "FK10")
    (,+key-F11+ "FK11")
    (,+key-F12+ "FK12")
    (,+key-F13+ "FK13")
    (,+key-F14+ "FK14")
    (,+key-F15+ "FK15")
    (,+key-F16+ "FK16")
    (,+key-F17+ "FK17")
    (,+key-F18+ "FK18")
    (,+key-F19+ "FK19")
    (,+key-F20+ "FK20")
    (,+key-F21+ "FK21")
    (,+key-F22+ "FK22")
    (,+key-F23+ "FK23")
    (,+key-F24+ "FK24")

    (,+key-pad-0+ "KP0")
    (,+key-pad-1+ "KP1")
    (,+key-pad-2+ "KP2")
    (,+key-pad-3+ "KP3")
    (,+key-pad-4+ "KP4")
    (,+key-pad-5+ "KP5")
    (,+key-pad-6+ "KP6")
    (,+key-pad-7+ "KP7")
    (,+key-pad-8+ "KP8")
    (,+key-pad-9+ "KP9")
    (,+key-pad-decimal-point+ "KLPD")
    (,+key-pad-slash+ "KLDV")
    (,+key-pad-asterisk+ "KPMU")
    (,+key-pad-minus+ "KPSU")
    (,+key-pad-plus+ "KPAD")
    (,+key-pad-enter+ "KPEN")
    (,+key-pad-equals+ "KPEQ")
    
    (,+key-left-shift+ "LFSH")
    (,+key-left-ctrl+ "LCTL")
    (,+key-left-alt+ "LALT")
    (,+key-left-GUI+ "LWIN")
    (,+key-right-shift+ "RTSH")
    (,+key-right-ctrl+ "RCTL")
    (,+key-right-alt+ "RALT")
    (,+key-right-alt+ "LVL3")
    (,+key-right-alt+ "MDSW")
    (,+key-right-GUI+ "RWIN")

    (,+key-menu+ "MENU")))

(defun create-x11-key-tables (display)

  (if (xkb-available? (display-x11-state display))

      ;; determines physical key locations independently of current keyboard layout
      ;; not sure how useful that is.

      ;; this function is slow as heck by the way
      
      (let ((desc (#_XkbGetMap (h display) 0 #_XkbUseCoreKbd)))

	(#_XkbGetNames (h display) (logior #_XkbKeyNamesMask #_XkbKeyAliasesMask) desc)

	(let ((scancode-min (#_.min_key_code desc))
	      (scancode-max (#_.max_key_code desc)))


	  (loop for scancode from scancode-min to scancode-max
		with key = nil
		do (loop for pair in *x11-querty-keymap*
			 do (let ((desc-name (#_.name (c-aref (#_.keys (#_.names desc)) scancode))))
			      (when (zerop (#_strncmp desc-name (cadr pair) #_XkbKeyNameLength))
				(setq key (car pair))
				(return))))

		   (unless key
		     (loop for i from 0 below (#_.num_key_aliases (#_.names desc))
			   unless (zerop (#_strncmp (#_.real (c-aref (#_.key_aliases (#_.names desc)) i))
						    (#_.name (c-aref (#_.keys (#_.names desc)) scancode))
						    #_XkbKeyNameLength))
			     do (loop for pair in *x11-querty-keymap*
				      do (let ((alias (#_.alias (c-aref (#_.key_aliases (#_.names desc)) i))))
					   (when (zerop (#_strncmp alias (cadr pair) #_XkbKeyNameLength))
					     (setq key (car pair))
					     (return))))))
		   (setf (aref (display-keycodes display) scancode) key)))

	(#_XkbFreeNames desc #_XkbKeyNamesMask #_True)
	(#_XkbFreeKeyboard desc 0 #_True)
	(values))

      (clet ((scancode-min #_<int>)
	     (scancode-max #_<int>)
	     (width #_<int>))

	(#_XDisplayKeycodes (h display) (c-addr-of scancode-min) (c-addr-of scancode-max))

	(let ((keysyms
		(#_XGetKeyboardMapping (h display)
				       scancode-min
				       (1+ (- (cval-value scancode-max) (cval-value scancode-min)))
				       (c-addr-of width))))
	  
	  (loop for scancode from (cval-value scancode-min) to (cval-value scancode-max)
		for i from 0
		unless (aref (display-keycodes display) scancode)
		do (let ((base (* i (cval-value width))))
		     (setf (aref (display-keycodes display) scancode)
			   (translate-x11-keysyms (noffi::c+ keysyms base) (cval-value width))))
	      when (aref (display-keycodes display) scancode)
		do (setf (aref (display-scancodes display) (aref (display-keycodes display) scancode)) scancode))
	  
	(#_XFree keysyms)
	(values)))))
	  

(defun translate-x11-keysyms (keysyms &optional (width 1))
  (block nil

    (let ((result nil))
      
      (when (> width 1)

	(setq result
	      (case (cval-value (c-aref keysyms 1))
		(#.#_XK_KP_0 +key-pad-0+)
		(#.#_XK_KP_1 +key-pad-1+)
		(#.#_XK_KP_2 +key-pad-2+)
		(#.#_XK_KP_3 +key-pad-3+)
		(#.#_XK_KP_4 +key-pad-4+)
		(#.#_XK_KP_5 +key-pad-5+)
		(#.#_XK_KP_6 +key-pad-6+)
		(#.#_XK_KP_7 +key-pad-7+)
		(#.#_XK_KP_8 +key-pad-8+)
		(#.#_XK_KP_9 +key-pad-9+)
		((#.#_XK_KP_Separator #.#_XK_KP_Decimal) +key-pad-decimal-point+)
		(#.#_XK_KP_Equal +key-pad-equals+)
		(#.#_XK_KP_Enter +key-pad-enter+))))

      (when result (return result))

      (case (cval-value (c-aref keysyms 0))
	(#.#_XK_Escape +key-escape+)
	(#.#_XK_Tab +key-tab+)
	(#.#_XK_Shift_L +key-left-shift+)
	(#.#_XK_Shift_R +key-right-shift+)
	(#.#_XK_Control_L +key-left-ctrl+)
	(#.#_XK_Control_R +key-right-ctrl+)
	((#.#_XK_Meta_L #.#_XK_Alt_L) +key-left-alt+)
	((#.#_XK_Mode_switch
	  #.#_XK_ISO_Level3_Shift
	  #.#_XK_Meta_R
	  #.#_XK_Alt_R) +key-right-alt+)
	(#.#_XK_Super_L +key-left-GUI+)
	(#.#_XK_Super_R +key-right-GUI+)
	(#.#_XK_Menu +key-menu+)
	(#.#_XK_Num_Lock +key-num-lock+)
	(#.#_XK_Caps_Lock +key-caps-lock+)
	(#.#_XK_Print +key-print-screen+)
	(#.#_XK_Scroll_Lock +key-scroll-lock+)
	(#.#_XK_Pause +key-pause+)
	(#.#_XK_Delete +key-delete+)
	(#.#_XK_BackSpace +key-backspace+)
	(#.#_XK_Return +key-enter+)
	(#.#_XK_Home +key-home+)
	(#.#_XK_End +key-end+)
	(#.#_XK_Page_Up +key-page-up+)
	(#.#_XK_Page_Down +key-page-down+)
	(#.#_XK_Insert +key-insert+)
	(#.#_XK_Left +key-left-arrow+)
	(#.#_XK_Right +key-right-arrow+)
	(#.#_XK_Down +key-down-arrow+)
	(#.#_XK_Up +key-up-arrow+)
	(#.#_XK_F1 +key-F1+)
	(#.#_XK_F2 +key-F2+)
	(#.#_XK_F3 +key-F3+)
	(#.#_XK_F4 +key-F4+)
	(#.#_XK_F5 +key-F5+)
	(#.#_XK_F6 +key-F6+)
	(#.#_XK_F7 +key-F7+)
	(#.#_XK_F8 +key-F8+)
	(#.#_XK_F9 +key-F9+)
	(#.#_XK_F10 +key-F10+)
	(#.#_XK_F11 +key-F11+)
	(#.#_XK_F12 +key-F12+)
	(#.#_XK_F13 +key-F13+)
	(#.#_XK_F14 +key-F14+)
	(#.#_XK_F15 +key-F15+)
	(#.#_XK_F16 +key-F16+)
	(#.#_XK_F17 +key-F17+)
	(#.#_XK_F18 +key-F18+)
	(#.#_XK_F19 +key-F19+)
	(#.#_XK_F20 +key-F20+)
	(#.#_XK_F21 +key-F21+)
	(#.#_XK_F22 +key-F22+)
	(#.#_XK_F23 +key-F23+)
	(#.#_XK_F24 +key-F24+)
	(#.#_XK_F25 nil)
	(#.#_XK_KP_Divide +key-pad-slash+)
	(#.#_XK_KP_Multiply +key-pad-asterisk+)
	(#.#_XK_KP_Subtract +key-pad-minus+)
	(#.#_XK_KP_Add +key-pad-plus+)
	(#.#_XK_KP_0 +key-pad-0+)
	(#.#_XK_KP_1 +key-pad-1+)
	(#.#_XK_KP_2 +key-pad-2+)
	(#.#_XK_KP_3 +key-pad-3+)
	(#.#_XK_KP_4 +key-pad-4+)
	(#.#_XK_KP_5 +key-pad-5+)
	(#.#_XK_KP_6 +key-pad-6+)
	(#.#_XK_KP_7 +key-pad-7+)
	(#.#_XK_KP_8 +key-pad-8+)
	(#.#_XK_KP_9 +key-pad-9+)
	((#.#_XK_KP_Separator #.#_XK_KP_Decimal) +key-pad-decimal-point+)
	(#.#_XK_KP_Equal +key-pad-equals+)
	(#.#_XK_KP_Enter +key-pad-enter+)
	(#.#_XK_a +key-A+)
	(#.#_XK_b +key-B+)
	(#.#_XK_c +key-C+)
	(#.#_XK_d +key-D+)
	(#.#_XK_e +key-E+)
	(#.#_XK_f +key-F+)
	(#.#_XK_g +key-G+)
	(#.#_XK_h +key-H+)
	(#.#_XK_i +key-I+)
	(#.#_XK_j +key-J+)
	(#.#_XK_k +key-K+)
	(#.#_XK_l +key-L+)
	(#.#_XK_m +key-M+)
	(#.#_XK_n +key-N+)
	(#.#_XK_o +key-O+)
	(#.#_XK_p +key-P+)
	(#.#_XK_q +key-Q+)
	(#.#_XK_r +key-R+)
	(#.#_XK_s +key-S+)
	(#.#_XK_t +key-T+)
	(#.#_XK_u +key-U+)
	(#.#_XK_v +key-V+)
	(#.#_XK_w +key-W+)
	(#.#_XK_x +key-X+)
	(#.#_XK_y +key-Y+)
	(#.#_XK_z +key-Z+)
	(#.#_XK_1 +key-1+)
	(#.#_XK_2 +key-2+)
	(#.#_XK_3 +key-3+)
	(#.#_XK_4 +key-4+)
	(#.#_XK_5 +key-5+)
	(#.#_XK_6 +key-6+)
	(#.#_XK_7 +key-7+)
	(#.#_XK_8 +key-8+)
	(#.#_XK_9 +key-9+)
	(#.#_XK_0 +key-0+)
	(#.#_XK_space +key-spacebar+)
	(#.#_XK_minus +key-minus+)
	(#.#_XK_equal +key-equals+)
	(#.#_XK_bracketleft +key-left-bracket+)
	(#.#_XK_bracketright +key-right-bracket+)
	(#.#_XK_backslash +key-backslash+)
	(#.#_XK_semicolon +key-semicolon+)
	(#.#_XK_apostrophe +key-apostrophe+)
	(#.#_XK_grave +key-grave-accent+)
	(#.#_XK_comma +key-comma+)
	(#.#_XK_period +key-period+)
	(#.#_XK_slash +key-slash+)
	(#.#_XK_less +key-international-1+)))))
      

(defparameter *xkb-keysym-unicode-alist*
  `(( #x01a1 #x0104 )
    ( #x01a2 #x02d8 )
    ( #x01a3 #x0141 )
    ( #x01a5 #x013d )
    ( #x01a6 #x015a )
    ( #x01a9 #x0160 )
    ( #x01aa #x015e )
    ( #x01ab #x0164 )
    ( #x01ac #x0179 )
    ( #x01ae #x017d )
    ( #x01af #x017b )
    ( #x01b1 #x0105 )
    ( #x01b2 #x02db )
    ( #x01b3 #x0142 )
    ( #x01b5 #x013e )
    ( #x01b6 #x015b )
    ( #x01b7 #x02c7 )
    ( #x01b9 #x0161 )
    ( #x01ba #x015f )
    ( #x01bb #x0165 )
    ( #x01bc #x017a )
    ( #x01bd #x02dd )
    ( #x01be #x017e )
    ( #x01bf #x017c )
    ( #x01c0 #x0154 )
    ( #x01c3 #x0102 )
    ( #x01c5 #x0139 )
    ( #x01c6 #x0106 )
    ( #x01c8 #x010c )
    ( #x01ca #x0118 )
    ( #x01cc #x011a )
    ( #x01cf #x010e )
    ( #x01d0 #x0110 )
    ( #x01d1 #x0143 )
    ( #x01d2 #x0147 )
    ( #x01d5 #x0150 )
    ( #x01d8 #x0158 )
    ( #x01d9 #x016e )
    ( #x01db #x0170 )
    ( #x01de #x0162 )
    ( #x01e0 #x0155 )
    ( #x01e3 #x0103 )
    ( #x01e5 #x013a )
    ( #x01e6 #x0107 )
    ( #x01e8 #x010d )
    ( #x01ea #x0119 )
    ( #x01ec #x011b )
    ( #x01ef #x010f )
    ( #x01f0 #x0111 )
    ( #x01f1 #x0144 )
    ( #x01f2 #x0148 )
    ( #x01f5 #x0151 )
    ( #x01f8 #x0159 )
    ( #x01f9 #x016f )
    ( #x01fb #x0171 )
    ( #x01fe #x0163 )
    ( #x01ff #x02d9 )
    ( #x02a1 #x0126 )
    ( #x02a6 #x0124 )
    ( #x02a9 #x0130 )
    ( #x02ab #x011e )
    ( #x02ac #x0134 )
    ( #x02b1 #x0127 )
    ( #x02b6 #x0125 )
    ( #x02b9 #x0131 )
    ( #x02bb #x011f )
    ( #x02bc #x0135 )
    ( #x02c5 #x010a )
    ( #x02c6 #x0108 )
    ( #x02d5 #x0120 )
    ( #x02d8 #x011c )
    ( #x02dd #x016c )
    ( #x02de #x015c )
    ( #x02e5 #x010b )
    ( #x02e6 #x0109 )
    ( #x02f5 #x0121 )
    ( #x02f8 #x011d )
    ( #x02fd #x016d )
    ( #x02fe #x015d )
    ( #x03a2 #x0138 )
    ( #x03a3 #x0156 )
    ( #x03a5 #x0128 )
    ( #x03a6 #x013b )
    ( #x03aa #x0112 )
    ( #x03ab #x0122 )
    ( #x03ac #x0166 )
    ( #x03b3 #x0157 )
    ( #x03b5 #x0129 )
    ( #x03b6 #x013c )
    ( #x03ba #x0113 )
    ( #x03bb #x0123 )
    ( #x03bc #x0167 )
    ( #x03bd #x014a )
    ( #x03bf #x014b )
    ( #x03c0 #x0100 )
    ( #x03c7 #x012e )
    ( #x03cc #x0116 )
    ( #x03cf #x012a )
    ( #x03d1 #x0145 )
    ( #x03d2 #x014c )
    ( #x03d3 #x0136 )
    ( #x03d9 #x0172 )
    ( #x03dd #x0168 )
    ( #x03de #x016a )
    ( #x03e0 #x0101 )
    ( #x03e7 #x012f )
    ( #x03ec #x0117 )
    ( #x03ef #x012b )
    ( #x03f1 #x0146 )
    ( #x03f2 #x014d )
    ( #x03f3 #x0137 )
    ( #x03f9 #x0173 )
    ( #x03fd #x0169 )
    ( #x03fe #x016b )
    ( #x047e #x203e )
    ( #x04a1 #x3002 )
    ( #x04a2 #x300c )
    ( #x04a3 #x300d )
    ( #x04a4 #x3001 )
    ( #x04a5 #x30fb )
    ( #x04a6 #x30f2 )
    ( #x04a7 #x30a1 )
    ( #x04a8 #x30a3 )
    ( #x04a9 #x30a5 )
    ( #x04aa #x30a7 )
    ( #x04ab #x30a9 )
    ( #x04ac #x30e3 )
    ( #x04ad #x30e5 )
    ( #x04ae #x30e7 )
    ( #x04af #x30c3 )
    ( #x04b0 #x30fc )
    ( #x04b1 #x30a2 )
    ( #x04b2 #x30a4 )
    ( #x04b3 #x30a6 )
    ( #x04b4 #x30a8 )
    ( #x04b5 #x30aa )
    ( #x04b6 #x30ab )
    ( #x04b7 #x30ad )
    ( #x04b8 #x30af )
    ( #x04b9 #x30b1 )
    ( #x04ba #x30b3 )
    ( #x04bb #x30b5 )
    ( #x04bc #x30b7 )
    ( #x04bd #x30b9 )
    ( #x04be #x30bb )
    ( #x04bf #x30bd )
    ( #x04c0 #x30bf )
    ( #x04c1 #x30c1 )
    ( #x04c2 #x30c4 )
    ( #x04c3 #x30c6 )
    ( #x04c4 #x30c8 )
    ( #x04c5 #x30ca )
    ( #x04c6 #x30cb )
    ( #x04c7 #x30cc )
    ( #x04c8 #x30cd )
    ( #x04c9 #x30ce )
    ( #x04ca #x30cf )
    ( #x04cb #x30d2 )
    ( #x04cc #x30d5 )
    ( #x04cd #x30d8 )
    ( #x04ce #x30db )
    ( #x04cf #x30de )
    ( #x04d0 #x30df )
    ( #x04d1 #x30e0 )
    ( #x04d2 #x30e1 )
    ( #x04d3 #x30e2 )
    ( #x04d4 #x30e4 )
    ( #x04d5 #x30e6 )
    ( #x04d6 #x30e8 )
    ( #x04d7 #x30e9 )
    ( #x04d8 #x30ea )
    ( #x04d9 #x30eb )
    ( #x04da #x30ec )
    ( #x04db #x30ed )
    ( #x04dc #x30ef )
    ( #x04dd #x30f3 )
    ( #x04de #x309b )
    ( #x04df #x309c )
    ( #x05ac #x060c )
    ( #x05bb #x061b )
    ( #x05bf #x061f )
    ( #x05c1 #x0621 )
    ( #x05c2 #x0622 )
    ( #x05c3 #x0623 )
    ( #x05c4 #x0624 )
    ( #x05c5 #x0625 )
    ( #x05c6 #x0626 )
    ( #x05c7 #x0627 )
    ( #x05c8 #x0628 )
    ( #x05c9 #x0629 )
    ( #x05ca #x062a )
    ( #x05cb #x062b )
    ( #x05cc #x062c )
    ( #x05cd #x062d )
    ( #x05ce #x062e )
    ( #x05cf #x062f )
    ( #x05d0 #x0630 )
    ( #x05d1 #x0631 )
    ( #x05d2 #x0632 )
    ( #x05d3 #x0633 )
    ( #x05d4 #x0634 )
    ( #x05d5 #x0635 )
    ( #x05d6 #x0636 )
    ( #x05d7 #x0637 )
    ( #x05d8 #x0638 )
    ( #x05d9 #x0639 )
    ( #x05da #x063a )
    ( #x05e0 #x0640 )
    ( #x05e1 #x0641 )
    ( #x05e2 #x0642 )
    ( #x05e3 #x0643 )
    ( #x05e4 #x0644 )
    ( #x05e5 #x0645 )
    ( #x05e6 #x0646 )
    ( #x05e7 #x0647 )
    ( #x05e8 #x0648 )
    ( #x05e9 #x0649 )
    ( #x05ea #x064a )
    ( #x05eb #x064b )
    ( #x05ec #x064c )
    ( #x05ed #x064d )
    ( #x05ee #x064e )
    ( #x05ef #x064f )
    ( #x05f0 #x0650 )
    ( #x05f1 #x0651 )
    ( #x05f2 #x0652 )
    ( #x06a1 #x0452 )
    ( #x06a2 #x0453 )
    ( #x06a3 #x0451 )
    ( #x06a4 #x0454 )
    ( #x06a5 #x0455 )
    ( #x06a6 #x0456 )
    ( #x06a7 #x0457 )
    ( #x06a8 #x0458 )
    ( #x06a9 #x0459 )
    ( #x06aa #x045a )
    ( #x06ab #x045b )
    ( #x06ac #x045c )
    ( #x06ae #x045e )
    ( #x06af #x045f )
    ( #x06b0 #x2116 )
    ( #x06b1 #x0402 )
    ( #x06b2 #x0403 )
    ( #x06b3 #x0401 )
    ( #x06b4 #x0404 )
    ( #x06b5 #x0405 )
    ( #x06b6 #x0406 )
    ( #x06b7 #x0407 )
    ( #x06b8 #x0408 )
    ( #x06b9 #x0409 )
    ( #x06ba #x040a )
    ( #x06bb #x040b )
    ( #x06bc #x040c )
    ( #x06be #x040e )
    ( #x06bf #x040f )
    ( #x06c0 #x044e )
    ( #x06c1 #x0430 )
    ( #x06c2 #x0431 )
    ( #x06c3 #x0446 )
    ( #x06c4 #x0434 )
    ( #x06c5 #x0435 )
    ( #x06c6 #x0444 )
    ( #x06c7 #x0433 )
    ( #x06c8 #x0445 )
    ( #x06c9 #x0438 )
    ( #x06ca #x0439 )
    ( #x06cb #x043a )
    ( #x06cc #x043b )
    ( #x06cd #x043c )
    ( #x06ce #x043d )
    ( #x06cf #x043e )
    ( #x06d0 #x043f )
    ( #x06d1 #x044f )
    ( #x06d2 #x0440 )
    ( #x06d3 #x0441 )
    ( #x06d4 #x0442 )
    ( #x06d5 #x0443 )
    ( #x06d6 #x0436 )
    ( #x06d7 #x0432 )
    ( #x06d8 #x044c )
    ( #x06d9 #x044b )
    ( #x06da #x0437 )
    ( #x06db #x0448 )
    ( #x06dc #x044d )
    ( #x06dd #x0449 )
    ( #x06de #x0447 )
    ( #x06df #x044a )
    ( #x06e0 #x042e )
    ( #x06e1 #x0410 )
    ( #x06e2 #x0411 )
    ( #x06e3 #x0426 )
    ( #x06e4 #x0414 )
    ( #x06e5 #x0415 )
    ( #x06e6 #x0424 )
    ( #x06e7 #x0413 )
    ( #x06e8 #x0425 )
    ( #x06e9 #x0418 )
    ( #x06ea #x0419 )
    ( #x06eb #x041a )
    ( #x06ec #x041b )
    ( #x06ed #x041c )
    ( #x06ee #x041d )
    ( #x06ef #x041e )
    ( #x06f0 #x041f )
    ( #x06f1 #x042f )
    ( #x06f2 #x0420 )
    ( #x06f3 #x0421 )
    ( #x06f4 #x0422 )
    ( #x06f5 #x0423 )
    ( #x06f6 #x0416 )
    ( #x06f7 #x0412 )
    ( #x06f8 #x042c )
    ( #x06f9 #x042b )
    ( #x06fa #x0417 )
    ( #x06fb #x0428 )
    ( #x06fc #x042d )
    ( #x06fd #x0429 )
    ( #x06fe #x0427 )
    ( #x06ff #x042a )
    ( #x07a1 #x0386 )
    ( #x07a2 #x0388 )
    ( #x07a3 #x0389 )
    ( #x07a4 #x038a )
    ( #x07a5 #x03aa )
    ( #x07a7 #x038c )
    ( #x07a8 #x038e )
    ( #x07a9 #x03ab )
    ( #x07ab #x038f )
    ( #x07ae #x0385 )
    ( #x07af #x2015 )
    ( #x07b1 #x03ac )
    ( #x07b2 #x03ad )
    ( #x07b3 #x03ae )
    ( #x07b4 #x03af )
    ( #x07b5 #x03ca )
    ( #x07b6 #x0390 )
    ( #x07b7 #x03cc )
    ( #x07b8 #x03cd )
    ( #x07b9 #x03cb )
    ( #x07ba #x03b0 )
    ( #x07bb #x03ce )
    ( #x07c1 #x0391 )
    ( #x07c2 #x0392 )
    ( #x07c3 #x0393 )
    ( #x07c4 #x0394 )
    ( #x07c5 #x0395 )
    ( #x07c6 #x0396 )
    ( #x07c7 #x0397 )
    ( #x07c8 #x0398 )
    ( #x07c9 #x0399 )
    ( #x07ca #x039a )
    ( #x07cb #x039b )
    ( #x07cc #x039c )
    ( #x07cd #x039d )
    ( #x07ce #x039e )
    ( #x07cf #x039f )
    ( #x07d0 #x03a0 )
    ( #x07d1 #x03a1 )
    ( #x07d2 #x03a3 )
    ( #x07d4 #x03a4 )
    ( #x07d5 #x03a5 )
    ( #x07d6 #x03a6 )
    ( #x07d7 #x03a7 )
    ( #x07d8 #x03a8 )
    ( #x07d9 #x03a9 )
    ( #x07e1 #x03b1 )
    ( #x07e2 #x03b2 )
    ( #x07e3 #x03b3 )
    ( #x07e4 #x03b4 )
    ( #x07e5 #x03b5 )
    ( #x07e6 #x03b6 )
    ( #x07e7 #x03b7 )
    ( #x07e8 #x03b8 )
    ( #x07e9 #x03b9 )
    ( #x07ea #x03ba )
    ( #x07eb #x03bb )
    ( #x07ec #x03bc )
    ( #x07ed #x03bd )
    ( #x07ee #x03be )
    ( #x07ef #x03bf )
    ( #x07f0 #x03c0 )
    ( #x07f1 #x03c1 )
    ( #x07f2 #x03c3 )
    ( #x07f3 #x03c2 )
    ( #x07f4 #x03c4 )
    ( #x07f5 #x03c5 )
    ( #x07f6 #x03c6 )
    ( #x07f7 #x03c7 )
    ( #x07f8 #x03c8 )
    ( #x07f9 #x03c9 )
    ( #x08a1 #x23b7 )
    ( #x08a2 #x250c )
    ( #x08a3 #x2500 )
    ( #x08a4 #x2320 )
    ( #x08a5 #x2321 )
    ( #x08a6 #x2502 )
    ( #x08a7 #x23a1 )
    ( #x08a8 #x23a3 )
    ( #x08a9 #x23a4 )
    ( #x08aa #x23a6 )
    ( #x08ab #x239b )
    ( #x08ac #x239d )
    ( #x08ad #x239e )
    ( #x08ae #x23a0 )
    ( #x08af #x23a8 )
    ( #x08b0 #x23ac )
    ( #x08bc #x2264 )
    ( #x08bd #x2260 )
    ( #x08be #x2265 )
    ( #x08bf #x222b )
    ( #x08c0 #x2234 )
    ( #x08c1 #x221d )
    ( #x08c2 #x221e )
    ( #x08c5 #x2207 )
    ( #x08c8 #x223c )
    ( #x08c9 #x2243 )
    ( #x08cd #x21d4 )
    ( #x08ce #x21d2 )
    ( #x08cf #x2261 )
    ( #x08d6 #x221a )
    ( #x08da #x2282 )
    ( #x08db #x2283 )
    ( #x08dc #x2229 )
    ( #x08dd #x222a )
    ( #x08de #x2227 )
    ( #x08df #x2228 )
    ( #x08ef #x2202 )
    ( #x08f6 #x0192 )
    ( #x08fb #x2190 )
    ( #x08fc #x2191 )
    ( #x08fd #x2192 )
    ( #x08fe #x2193 )
    ( #x09e0 #x25c6 )
    ( #x09e1 #x2592 )
    ( #x09e2 #x2409 )
    ( #x09e3 #x240c )
    ( #x09e4 #x240d )
    ( #x09e5 #x240a )
    ( #x09e8 #x2424 )
    ( #x09e9 #x240b )
    ( #x09ea #x2518 )
    ( #x09eb #x2510 )
    ( #x09ec #x250c )
    ( #x09ed #x2514 )
    ( #x09ee #x253c )
    ( #x09ef #x23ba )
    ( #x09f0 #x23bb )
    ( #x09f1 #x2500 )
    ( #x09f2 #x23bc )
    ( #x09f3 #x23bd )
    ( #x09f4 #x251c )
    ( #x09f5 #x2524 )
    ( #x09f6 #x2534 )
    ( #x09f7 #x252c )
    ( #x09f8 #x2502 )
    ( #x0aa1 #x2003 )
    ( #x0aa2 #x2002 )
    ( #x0aa3 #x2004 )
    ( #x0aa4 #x2005 )
    ( #x0aa5 #x2007 )
    ( #x0aa6 #x2008 )
    ( #x0aa7 #x2009 )
    ( #x0aa8 #x200a )
    ( #x0aa9 #x2014 )
    ( #x0aaa #x2013 )
    ( #x0aae #x2026 )
    ( #x0aaf #x2025 )
    ( #x0ab0 #x2153 )
    ( #x0ab1 #x2154 )
    ( #x0ab2 #x2155 )
    ( #x0ab3 #x2156 )
    ( #x0ab4 #x2157 )
    ( #x0ab5 #x2158 )
    ( #x0ab6 #x2159 )
    ( #x0ab7 #x215a )
    ( #x0ab8 #x2105 )
    ( #x0abb #x2012 )
    ( #x0abc #x2329 )
    ( #x0abe #x232a )
    ( #x0ac3 #x215b )
    ( #x0ac4 #x215c )
    ( #x0ac5 #x215d )
    ( #x0ac6 #x215e )
    ( #x0ac9 #x2122 )
    ( #x0aca #x2613 )
    ( #x0acc #x25c1 )
    ( #x0acd #x25b7 )
    ( #x0ace #x25cb )
    ( #x0acf #x25af )
    ( #x0ad0 #x2018 )
    ( #x0ad1 #x2019 )
    ( #x0ad2 #x201c )
    ( #x0ad3 #x201d )
    ( #x0ad4 #x211e )
    ( #x0ad6 #x2032 )
    ( #x0ad7 #x2033 )
    ( #x0ad9 #x271d )
    ( #x0adb #x25ac )
    ( #x0adc #x25c0 )
    ( #x0add #x25b6 )
    ( #x0ade #x25cf )
    ( #x0adf #x25ae )
    ( #x0ae0 #x25e6 )
    ( #x0ae1 #x25ab )
    ( #x0ae2 #x25ad )
    ( #x0ae3 #x25b3 )
    ( #x0ae4 #x25bd )
    ( #x0ae5 #x2606 )
    ( #x0ae6 #x2022 )
    ( #x0ae7 #x25aa )
    ( #x0ae8 #x25b2 )
    ( #x0ae9 #x25bc )
    ( #x0aea #x261c )
    ( #x0aeb #x261e )
    ( #x0aec #x2663 )
    ( #x0aed #x2666 )
    ( #x0aee #x2665 )
    ( #x0af0 #x2720 )
    ( #x0af1 #x2020 )
    ( #x0af2 #x2021 )
    ( #x0af3 #x2713 )
    ( #x0af4 #x2717 )
    ( #x0af5 #x266f )
    ( #x0af6 #x266d )
    ( #x0af7 #x2642 )
    ( #x0af8 #x2640 )
    ( #x0af9 #x260e )
    ( #x0afa #x2315 )
    ( #x0afb #x2117 )
    ( #x0afc #x2038 )
    ( #x0afd #x201a )
    ( #x0afe #x201e )
    ( #x0ba3 #x003c )
    ( #x0ba6 #x003e )
    ( #x0ba8 #x2228 )
    ( #x0ba9 #x2227 )
    ( #x0bc0 #x00af )
    ( #x0bc2 #x22a5 )
    ( #x0bc3 #x2229 )
    ( #x0bc4 #x230a )
    ( #x0bc6 #x005f )
    ( #x0bca #x2218 )
    ( #x0bcc #x2395 )
    ( #x0bce #x22a4 )
    ( #x0bcf #x25cb )
    ( #x0bd3 #x2308 )
    ( #x0bd6 #x222a )
    ( #x0bd8 #x2283 )
    ( #x0bda #x2282 )
    ( #x0bdc #x22a2 )
    ( #x0bfc #x22a3 )
    ( #x0cdf #x2017 )
    ( #x0ce0 #x05d0 )
    ( #x0ce1 #x05d1 )
    ( #x0ce2 #x05d2 )
    ( #x0ce3 #x05d3 )
    ( #x0ce4 #x05d4 )
    ( #x0ce5 #x05d5 )
    ( #x0ce6 #x05d6 )
    ( #x0ce7 #x05d7 )
    ( #x0ce8 #x05d8 )
    ( #x0ce9 #x05d9 )
    ( #x0cea #x05da )
    ( #x0ceb #x05db )
    ( #x0cec #x05dc )
    ( #x0ced #x05dd )
    ( #x0cee #x05de )
    ( #x0cef #x05df )
    ( #x0cf0 #x05e0 )
    ( #x0cf1 #x05e1 )
    ( #x0cf2 #x05e2 )
    ( #x0cf3 #x05e3 )
    ( #x0cf4 #x05e4 )
    ( #x0cf5 #x05e5 )
    ( #x0cf6 #x05e6 )
    ( #x0cf7 #x05e7 )
    ( #x0cf8 #x05e8 )
    ( #x0cf9 #x05e9 )
    ( #x0cfa #x05ea )
    ( #x0da1 #x0e01 )
    ( #x0da2 #x0e02 )
    ( #x0da3 #x0e03 )
    ( #x0da4 #x0e04 )
    ( #x0da5 #x0e05 )
    ( #x0da6 #x0e06 )
    ( #x0da7 #x0e07 )
    ( #x0da8 #x0e08 )
    ( #x0da9 #x0e09 )
    ( #x0daa #x0e0a )
    ( #x0dab #x0e0b )
    ( #x0dac #x0e0c )
    ( #x0dad #x0e0d )
    ( #x0dae #x0e0e )
    ( #x0daf #x0e0f )
    ( #x0db0 #x0e10 )
    ( #x0db1 #x0e11 )
    ( #x0db2 #x0e12 )
    ( #x0db3 #x0e13 )
    ( #x0db4 #x0e14 )
    ( #x0db5 #x0e15 )
    ( #x0db6 #x0e16 )
    ( #x0db7 #x0e17 )
    ( #x0db8 #x0e18 )
    ( #x0db9 #x0e19 )
    ( #x0dba #x0e1a )
    ( #x0dbb #x0e1b )
    ( #x0dbc #x0e1c )
    ( #x0dbd #x0e1d )
    ( #x0dbe #x0e1e )
    ( #x0dbf #x0e1f )
    ( #x0dc0 #x0e20 )
    ( #x0dc1 #x0e21 )
    ( #x0dc2 #x0e22 )
    ( #x0dc3 #x0e23 )
    ( #x0dc4 #x0e24 )
    ( #x0dc5 #x0e25 )
    ( #x0dc6 #x0e26 )
    ( #x0dc7 #x0e27 )
    ( #x0dc8 #x0e28 )
    ( #x0dc9 #x0e29 )
    ( #x0dca #x0e2a )
    ( #x0dcb #x0e2b )
    ( #x0dcc #x0e2c )
    ( #x0dcd #x0e2d )
    ( #x0dce #x0e2e )
    ( #x0dcf #x0e2f )
    ( #x0dd0 #x0e30 )
    ( #x0dd1 #x0e31 )
    ( #x0dd2 #x0e32 )
    ( #x0dd3 #x0e33 )
    ( #x0dd4 #x0e34 )
    ( #x0dd5 #x0e35 )
    ( #x0dd6 #x0e36 )
    ( #x0dd7 #x0e37 )
    ( #x0dd8 #x0e38 )
    ( #x0dd9 #x0e39 )
    ( #x0dda #x0e3a )
    ( #x0ddf #x0e3f )
    ( #x0de0 #x0e40 )
    ( #x0de1 #x0e41 )
    ( #x0de2 #x0e42 )
    ( #x0de3 #x0e43 )
    ( #x0de4 #x0e44 )
    ( #x0de5 #x0e45 )
    ( #x0de6 #x0e46 )
    ( #x0de7 #x0e47 )
    ( #x0de8 #x0e48 )
    ( #x0de9 #x0e49 )
    ( #x0dea #x0e4a )
    ( #x0deb #x0e4b )
    ( #x0dec #x0e4c )
    ( #x0ded #x0e4d )
    ( #x0df0 #x0e50 )
    ( #x0df1 #x0e51 )
    ( #x0df2 #x0e52 )
    ( #x0df3 #x0e53 )
    ( #x0df4 #x0e54 )
    ( #x0df5 #x0e55 )
    ( #x0df6 #x0e56 )
    ( #x0df7 #x0e57 )
    ( #x0df8 #x0e58 )
    ( #x0df9 #x0e59 )
    ( #x0ea1 #x3131 )
    ( #x0ea2 #x3132 )
    ( #x0ea3 #x3133 )
    ( #x0ea4 #x3134 )
    ( #x0ea5 #x3135 )
    ( #x0ea6 #x3136 )
    ( #x0ea7 #x3137 )
    ( #x0ea8 #x3138 )
    ( #x0ea9 #x3139 )
    ( #x0eaa #x313a )
    ( #x0eab #x313b )
    ( #x0eac #x313c )
    ( #x0ead #x313d )
    ( #x0eae #x313e )
    ( #x0eaf #x313f )
    ( #x0eb0 #x3140 )
    ( #x0eb1 #x3141 )
    ( #x0eb2 #x3142 )
    ( #x0eb3 #x3143 )
    ( #x0eb4 #x3144 )
    ( #x0eb5 #x3145 )
    ( #x0eb6 #x3146 )
    ( #x0eb7 #x3147 )
    ( #x0eb8 #x3148 )
    ( #x0eb9 #x3149 )
    ( #x0eba #x314a )
    ( #x0ebb #x314b )
    ( #x0ebc #x314c )
    ( #x0ebd #x314d )
    ( #x0ebe #x314e )
    ( #x0ebf #x314f )
    ( #x0ec0 #x3150 )
    ( #x0ec1 #x3151 )
    ( #x0ec2 #x3152 )
    ( #x0ec3 #x3153 )
    ( #x0ec4 #x3154 )
    ( #x0ec5 #x3155 )
    ( #x0ec6 #x3156 )
    ( #x0ec7 #x3157 )
    ( #x0ec8 #x3158 )
    ( #x0ec9 #x3159 )
    ( #x0eca #x315a )
    ( #x0ecb #x315b )
    ( #x0ecc #x315c )
    ( #x0ecd #x315d )
    ( #x0ece #x315e )
    ( #x0ecf #x315f )
    ( #x0ed0 #x3160 )
    ( #x0ed1 #x3161 )
    ( #x0ed2 #x3162 )
    ( #x0ed3 #x3163 )
    ( #x0ed4 #x11a8 )
    ( #x0ed5 #x11a9 )
    ( #x0ed6 #x11aa )
    ( #x0ed7 #x11ab )
    ( #x0ed8 #x11ac )
    ( #x0ed9 #x11ad )
    ( #x0eda #x11ae )
    ( #x0edb #x11af )
    ( #x0edc #x11b0 )
    ( #x0edd #x11b1 )
    ( #x0ede #x11b2 )
    ( #x0edf #x11b3 )
    ( #x0ee0 #x11b4 )
    ( #x0ee1 #x11b5 )
    ( #x0ee2 #x11b6 )
    ( #x0ee3 #x11b7 )
    ( #x0ee4 #x11b8 )
    ( #x0ee5 #x11b9 )
    ( #x0ee6 #x11ba )
    ( #x0ee7 #x11bb )
    ( #x0ee8 #x11bc )
    ( #x0ee9 #x11bd )
    ( #x0eea #x11be )
    ( #x0eeb #x11bf )
    ( #x0eec #x11c0 )
    ( #x0eed #x11c1 )
    ( #x0eee #x11c2 )
    ( #x0eef #x316d )
    ( #x0ef0 #x3171 )
    ( #x0ef1 #x3178 )
    ( #x0ef2 #x317f )
    ( #x0ef3 #x3181 )
    ( #x0ef4 #x3184 )
    ( #x0ef5 #x3186 )
    ( #x0ef6 #x318d )
    ( #x0ef7 #x318e )
    ( #x0ef8 #x11eb )
    ( #x0ef9 #x11f0 )
    ( #x0efa #x11f9 )
    ( #x0eff #x20a9 )
    ( #x13a4 #x20ac )
    ( #x13bc #x0152 )
    ( #x13bd #x0153 )
    ( #x13be #x0178 )
    ( #x20ac #x20ac )
    ( #xfe50    ,(char-code #\`) )
    ( #xfe51 #x00b4 )
    ( #xfe52    ,(char-code #\^) )
    ( #xfe53    ,(char-code #\~) )
    ( #xfe54 #x00af )
    ( #xfe55 #x02d8 )
    ( #xfe56 #x02d9 )
    ( #xfe57 #x00a8 )
    ( #xfe58 #x02da )
    ( #xfe59 #x02dd )
    ( #xfe5a #x02c7 )
    ( #xfe5b #x00b8 )
    ( #xfe5c #x02db )
    ( #xfe5d #x037a )
    ( #xfe5e #x309b )
    ( #xfe5f #x309c )
    ( #xfe63    (char-code #\/) )
    ( #xfe64 #x02bc )
    ( #xfe65 #x02bd )
    ( #xfe66 #x02f5 )
    ( #xfe67 #x02f3 )
    ( #xfe68 #x02cd )
    ( #xfe69 #xa788 )
    ( #xfe6a #x02f7 )
;;    ( #xfe6e    '' )
    ( #xfe6f #x00a4 )
    ( #xfe80    ,(char-code #\a) ) ;;// XK_dead_a
    ( #xfe81    ,(char-code #\A) ) ;;// XK_dead_A
    ( #xfe82    ,(char-code #\e) ) ;;// XK_dead_e
    ( #xfe83    ,(char-code #\E) ) ;;// XK_dead_E
    ( #xfe84    ,(char-code #\i) ) ;;// XK_dead_i
    ( #xfe85    ,(char-code #\I) ) ;;// XK_dead_I
    ( #xfe86    ,(char-code #\o) ) ;;// XK_dead_o
    ( #xfe87    ,(char-code #\O) ) ;;// XK_dead_O
    ( #xfe88    ,(char-code #\u) ) ;;// XK_dead_u
    ( #xfe89    ,(char-code #\U) ) ;;// XK_dead_U
    ( #xfe8a #x0259 )
    ( #xfe8b #x018f )
    ( #xfe8c #x00b5 )
    ( #xfe90    ,(char-code #\_) )
    ( #xfe91 #x02c8 )
    ( #xfe92 #x02cc )
    ( #xff80 #|XKB_KEY_KP_Space|#     (char-code #\space) )
    ( #xff95 #|XKB_KEY_KP_7|# #x0037 )
    ( #xff96 #|XKB_KEY_KP_4|# #x0034 )
    ( #xff97 #|XKB_KEY_KP_8|# #x0038 )
    ( #xff98 #|XKB_KEY_KP_6|# #x0036 )
    ( #xff99 #|XKB_KEY_KP_2|# #x0032 )
    ( #xff9a #|XKB_KEY_KP_9|# #x0039 )
    ( #xff9b #|XKB_KEY_KP_3|# #x0033 )
    ( #xff9c #|XKB_KEY_KP_1|# #x0031 )
    ( #xff9d #|XKB_KEY_KP_5|# #x0035 )
    ( #xff9e #|XKB_KEY_KP_0|# #x0030 )
    ( #xffaa #|XKB_KEY_KP_Multiply|#  ,(char-code #\*) )
    ( #xffab #|XKB_KEY_KP_Add|#       ,(char-code #\+) )
    ;;( #xffac #|XKB_KEY_KP_Separator|# '' )
    ( #xffad #|XKB_KEY_KP_Subtract|#  ,(char-code #\-) )
    ( #xffae #|XKB_KEY_KP_Decimal|#   ,(char-code #\.) )
    ( #xffaf #|XKB_KEY_KP_Divide|#    ,(char-code #\/) )
    ( #xffb0 #|XKB_KEY_KP_0|# #x0030 )
    ( #xffb1 #|XKB_KEY_KP_1|# #x0031 )
    ( #xffb2 #|XKB_KEY_KP_2|# #x0032 )
    ( #xffb3 #|XKB_KEY_KP_3|# #x0033 )
    ( #xffb4 #|XKB_KEY_KP_4|# #x0034 )
    ( #xffb5 #|XKB_KEY_KP_5|# #x0035 )
    ( #xffb6 #|XKB_KEY_KP_6|# #x0036 )
    ( #xffb7 #|XKB_KEY_KP_7|# #x0037 )
    ( #xffb8 #|XKB_KEY_KP_8|# #x0038 )
    ( #xffb9 #|XKB_KEY_KP_9|# #x0039 )
    ( #xffbd #|XKB_KEY_KP_Equal|#     ,(char-code #\=) )))

(defparameter *xkb-keysym->unicode-table*
  (let ((ht (make-hash-table :test #'eq)))
    (loop for pair in *xkb-keysym-unicode-alist*
	  do (setf (gethash (car pair) ht) (cadr pair)))
    ht))

(defun xkb-keysym-to-unicode (keysym)
  (block nil
    
    (when (or (and (>= keysym #x0020) (<= keysym #x007e))
	      (and (>= keysym #x00a0) (<= keysym #x00ff)))
      (return (code-char keysym)))

    (let ((codepoint (gethash keysym *xkb-keysym->unicode-table*)))
      (when codepoint
	(code-char codepoint)))))
      
